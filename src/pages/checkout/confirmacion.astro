---
// src/pages/checkout/confirmacion.astro - CON TYPE GUARDS (ALTERNATIVA)
import Layout from '../../components/layout/Layout.astro';
import { supabase } from '../../lib/supabase';
import type { Order, OrderItem } from '../../lib/types';

// Get order ID from URL parameters
const url = new URL(Astro.request.url);
const orderId = url.searchParams.get('order');

let order: Order | null = null;
let error: string | null = null;

// Fetch order details if orderId is provided
if (orderId) {
  try {
    const { data, error: fetchError } = await supabase
      .from('orders')
      .select('*')
      .eq('id', orderId)
      .single();
    
    if (fetchError) throw fetchError;
    order = data;
  } catch (e: unknown) {
    console.error('Error fetching order:', e);
    error = e instanceof Error ? e.message : 'Error desconocido';
  }
}

// ✅ ALTERNATIVA: Type Guard Function
const isValidOrder = (order: Order | null, error: string | null): order is Order => {
  return order !== null && !error;
};

// Usar el type guard
const validOrder = isValidOrder(order, error) ? order : null;
---

<Layout 
  title={validOrder ? `Pedido Confirmado #${validOrder.order_number}` : 'Confirmación de Pedido'}
  description="Tu pedido ha sido procesado exitosamente"
  noindex={true}
>
  <div class="min-h-screen bg-gray-50 py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      
      {validOrder ? (
        <!-- Success State -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          
          <!-- Header -->
          <div class="bg-green-50 border-b border-green-200 px-6 py-8 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">¡Pedido Confirmado!</h1>
            <p class="text-lg text-gray-600">
              Tu pedido #{validOrder.order_number} ha sido procesado exitosamente
            </p>
          </div>

          <!-- Order Details -->
          <div class="p-6 space-y-8">
            
            <!-- Order Summary -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              
              <!-- Order Info -->
              <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Información del Pedido</h3>
                <dl class="space-y-3">
                  <div class="flex justify-between">
                    <dt class="text-gray-600">Número de pedido:</dt>
                    <dd class="font-medium text-gray-800">{validOrder.order_number}</dd>
                  </div>
                  <div class="flex justify-between">
                    <dt class="text-gray-600">Fecha:</dt>
                    <dd class="font-medium text-gray-800">
                      {new Date(validOrder.created_at).toLocaleDateString('es-CO', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })}
                    </dd>
                  </div>
                  <div class="flex justify-between">
                    <dt class="text-gray-600">Estado:</dt>
                    <dd>
                      <span class={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                        validOrder.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                        validOrder.status === 'processing' ? 'bg-blue-100 text-blue-800' :
                        validOrder.status === 'shipped' ? 'bg-purple-100 text-purple-800' :
                        validOrder.status === 'delivered' ? 'bg-green-100 text-green-800' :
                        'bg-gray-100 text-gray-800'
                      }`}>
                        {validOrder.status === 'pending' ? 'Pendiente' :
                         validOrder.status === 'processing' ? 'Procesando' :
                         validOrder.status === 'shipped' ? 'Enviado' :
                         validOrder.status === 'delivered' ? 'Entregado' :
                         validOrder.status}
                      </span>
                    </dd>
                  </div>
                  <div class="flex justify-between">
                    <dt class="text-gray-600">Total:</dt>
                    <dd class="font-bold text-xl text-primary-600">
                      ${validOrder.total.toLocaleString('es-CO')}
                    </dd>
                  </div>
                </dl>
              </div>

              <!-- Shipping Address -->
              <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Dirección de Envío</h3>
                <div class="bg-gray-50 rounded-lg p-4">
                  <p class="font-medium text-gray-800">{validOrder.shipping_address.full_name}</p>
                  <p class="text-gray-600">{validOrder.shipping_address.address_line_1}</p>
                  {validOrder.shipping_address.address_line_2 && (
                    <p class="text-gray-600">{validOrder.shipping_address.address_line_2}</p>
                  )}
                  <p class="text-gray-600">
                    {validOrder.shipping_address.city}, {validOrder.shipping_address.state} {validOrder.shipping_address.postal_code}
                  </p>
                  <p class="text-gray-600">{validOrder.shipping_address.country}</p>
                  
                  <div class="mt-3 pt-3 border-t border-gray-200">
                    <p class="text-sm text-gray-600">
                      <span class="font-medium">Email:</span> {validOrder.shipping_address.email}
                    </p>
                    <p class="text-sm text-gray-600">
                      <span class="font-medium">Teléfono:</span> {validOrder.shipping_address.phone}
                    </p>
                  </div>
                </div>
              </div>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Productos Ordenados</h3>
              <div class="bg-gray-50 rounded-lg overflow-hidden">
                <div class="divide-y divide-gray-200">
                  {/* ✅ CORREGIDO: Tipo explícito para item */}
                  {order.items.map((item: OrderItem) => (
                    <div class="p-4 flex items-center space-x-4">
                      <div class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden flex-shrink-0">
                        <div class="w-full h-full bg-gray-300 flex items-center justify-center">
                          <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                        </div>
                      </div>
                      
                      <div class="flex-1">
                        <h4 class="font-medium text-gray-800">{item.product_name}</h4>
                        <p class="text-sm text-gray-600">Cantidad: {item.quantity}</p>
                        <p class="text-sm font-medium text-gray-800">
                          ${item.price.toLocaleString('es-CO')} c/u
                        </p>
                      </div>
                      
                      <div class="text-right">
                        <p class="font-semibold text-gray-800">
                          ${item.total.toLocaleString('es-CO')}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
                
                <!-- Order Totals -->
                <div class="bg-white border-t border-gray-200 p-4 space-y-2">
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Subtotal:</span>
                    <span class="font-medium">${order.subtotal.toLocaleString('es-CO')}</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Envío:</span>
                    <span class="font-medium">
                      {order.shipping_cost === 0 ? (
                        <span class="text-green-600">Gratis</span>
                      ) : (
                        `$${order.shipping_cost.toLocaleString('es-CO')}`
                      )}
                    </span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600">IVA (19%):</span>
                    <span class="font-medium">${order.tax.toLocaleString('es-CO')}</span>
                  </div>
                  <div class="flex justify-between text-lg font-bold pt-2 border-t border-gray-200">
                    <span>Total:</span>
                    <span class="text-primary-600">${order.total.toLocaleString('es-CO')}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Next Steps -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-blue-900 mb-4">¿Qué sigue?</h3>
              <div class="space-y-3">
                <div class="flex items-start space-x-3">
                  <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mt-0.5">1</div>
                  <div>
                    <p class="font-medium text-blue-900">Confirmación por email</p>
                    <p class="text-sm text-blue-700">Te enviaremos un email de confirmación con todos los detalles a {order.shipping_address.email}</p>
                  </div>
                </div>
                
                <div class="flex items-start space-x-3">
                  <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mt-0.5">2</div>
                  <div>
                    <p class="font-medium text-blue-900">Preparación del pedido</p>
                    <p class="text-sm text-blue-700">Nuestro equipo preparará tu pedido con la máxima discreción</p>
                  </div>
                </div>
                
                <div class="flex items-start space-x-3">
                  <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mt-0.5">3</div>
                  <div>
                    <p class="font-medium text-blue-900">Envío discreto</p>
                    <p class="text-sm text-blue-700">Tu pedido será enviado en un paquete neutro sin identificación del contenido</p>
                  </div>
                </div>
                
                <div class="flex items-start space-x-3">
                  <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mt-0.5">4</div>
                  <div>
                    <p class="font-medium text-blue-900">Seguimiento</p>
                    <p class="text-sm text-blue-700">Recibirás un código de seguimiento para rastrear tu envío</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
              <a href="/cuenta/pedidos" class="btn-primary text-center">
                Ver mis pedidos
              </a>
              <a href="/productos" class="btn-secondary text-center">
                Seguir comprando
              </a>
            </div>
          </div>
        </div>
      ) : (
        <!-- Error State -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-gray-800 mb-4">
            {orderId ? 'Pedido no encontrado' : 'Error en la confirmación'}
          </h1>
          <p class="text-gray-600 mb-6">
            {orderId 
              ? `No pudimos encontrar el pedido ${orderId}. Verifica el enlace o contacta a soporte.`
              : 'No se proporcionó un número de pedido válido.'
            }
          </p>
          <div class="space-x-4">
            <a href="/productos" class="btn-primary">
              Ir a la tienda
            </a>
            <a href="/contacto" class="btn-secondary">
              Contactar soporte
            </a>
          </div>
        </div>
      )}

      <!-- Support Contact -->
      <div class="mt-8 text-center">
        <p class="text-sm text-gray-600">
          ¿Tienes alguna pregunta sobre tu pedido? 
          <a href="/contacto" class="text-primary-600 hover:text-primary-700 font-medium">Contáctanos</a>
          o llama al <a href="tel:+573001234567" class="text-primary-600 hover:text-primary-700 font-medium">300 123 4567</a>
        </p>
      </div>
    </div>
  </div>
</Layout>