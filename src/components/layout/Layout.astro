---
// src/components/layout/Layout.astro - LAYOUT ACTUALIZADO CON CART LOADER
import Header from './Header.astro';
import Footer from './Footer.astro';
import { GlobalCart } from '../react/Cart';

export interface Props {
  title: string;
  description?: string;
  image?: string;
  noIndex?: boolean;
}

const { 
  title, 
  description = "Martek - Bases para camas de alta calidad. M√°s de 45 a√±os de experiencia en muebles.",
  image = "/images/og-image.jpg",
  noIndex = false 
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <link rel="canonical" href={canonicalURL} />
    
    <!-- SEO Meta Tags -->
    <title>{title}</title>
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={image} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={image} />
    
    {noIndex && <meta name="robots" content="noindex, nofollow" />}

    <!-- ‚úÖ CARGAR CART LOADER PRIMERO - CR√çTICO PARA PRODUCCI√ìN -->
    <script src="/js/cart-loader.js" is:inline></script>
    
    <!-- ‚úÖ CARGAR SISTEMA DE CARRITO SEGUNDO -->
    <script src="/js/cart.js" is:inline></script>

    <!-- Preload critical fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Critical CSS inline for performance -->
    <style>
      /* Critical above-the-fold styles */
      body { 
        font-family: system-ui, -apple-system, sans-serif; 
        margin: 0; 
        line-height: 1.6; 
      }
      .loading { 
        opacity: 0.5; 
        pointer-events: none; 
      }
    </style>
  </head>
  
  <body>
    <!-- Header -->
    <Header />
    
    <!-- Main Content -->
    <main>
      <slot />
    </main>
    
    <!-- Footer -->
    <Footer />
    
    <!-- ‚úÖ CARRITO GLOBAL - SE CARGA DESPU√âS DE QUE EL SISTEMA EST√â LISTO -->
    <div id="global-cart-container"></div>
    
    <!-- ‚úÖ SCRIPT PARA CARGAR CARRITO GLOBAL DE FORMA SEGURA -->
    <script>
      // Esperar a que React y el sistema de carrito est√©n disponibles
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          // ‚úÖ ESPERAR A QUE EL CARRITO EST√â DISPONIBLE
          const cartReady = await window.waitForCart(15000);
          
          if (!cartReady) {
            console.error('‚ùå No se pudo cargar el sistema de carrito global');
            return;
          }

          // ‚úÖ CARGAR COMPONENTE REACT DEL CARRITO
          const [{ GlobalCart }, React, ReactDOM] = await Promise.all([
            import('../react/Cart'),
            import('react'),
            import('react-dom/client')
          ]);

          const container = document.getElementById('global-cart-container');
          if (container) {
            const root = ReactDOM.createRoot(container);
            root.render(React.createElement(GlobalCart));
            console.log('‚úÖ Carrito global cargado exitosamente');
          }
        } catch (error) {
          console.error('‚ùå Error cargando carrito global:', error);
        }
      });
    </script>

    <!-- Analytics y scripts no cr√≠ticos al final -->
    <script>
      // Google Analytics u otros scripts de tracking aqu√≠
      console.log('üìä Layout cargado - Analytics ready');
    </script>
  </body>
</html>