---
// src/components/layout/Layout.astro - LAYOUT MARTEK CON CARRITO
import Header from './Header.astro';
import Footer from './Footer.astro';
import { GlobalCart } from '../react/Cart';

export interface Props {
  title: string;
  description?: string;
  image?: string;
  noIndex?: boolean;
}

const { 
  title, 
  description = "Martek - Bases para camas de alta calidad. M√°s de 45 a√±os de experiencia en muebles.",
  image = "/images/og-default.jpg",
  noIndex = false 
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- SEO Meta Tags -->
  <title>{title}</title>
  <meta name="description" content={description} />
  <link rel="canonical" href={canonicalURL} />
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content={canonicalURL} />
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={new URL(image, Astro.url)} />
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content={canonicalURL} />
  <meta property="twitter:title" content={title} />
  <meta property="twitter:description" content={description} />
  <meta property="twitter:image" content={new URL(image, Astro.url)} />
  
  <!-- Robots -->
  {noIndex && <meta name="robots" content="noindex, nofollow" />}
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="icon" type="image/png" href="/favicon.png" />
  
  <!-- ‚úÖ HELPER PARA NETLIFY - AGREGADO ANTES DE cart.js -->
  <script is:inline>
    // üîß Helper para esperar que cart.js cargue completamente
    window.waitForCartAPI = function(timeout = 15000) {
      return new Promise((resolve) => {
        // Si ya est√° disponible
        if (typeof window.CartAPI !== 'undefined' && typeof window.addToCart === 'function') {
          console.log('‚úÖ CartAPI ya disponible');
          resolve(true);
          return;
        }

        console.log('‚è≥ Esperando CartAPI...');
        const startTime = Date.now();
        
        const checkInterval = setInterval(() => {
          // Verificar si CartAPI est√° disponible
          if (typeof window.CartAPI !== 'undefined' && typeof window.addToCart === 'function') {
            clearInterval(checkInterval);
            console.log('‚úÖ CartAPI cargado exitosamente');
            resolve(true);
            return;
          }

          // Timeout
          if (Date.now() - startTime > timeout) {
            clearInterval(checkInterval);
            console.error('‚ùå Timeout: CartAPI no disponible despu√©s de', timeout, 'ms');
            resolve(false);
          }
        }, 100);
      });
    };

    // üîß Funci√≥n segura para agregar al carrito
    window.safeAddToCart = async function(productId, productName, productPrice, quantity = 1) {
      const isReady = await window.waitForCartAPI();
      if (isReady && typeof window.addToCart === 'function') {
        window.addToCart(productId, productName, productPrice, quantity);
        return true;
      } else {
        console.error('No se pudo agregar al carrito - CartAPI no disponible');
        alert('Error: Sistema de carrito no disponible. Por favor, recarga la p√°gina.');
        return false;
      }
    };

    console.log('üîß Cart Helper cargado');
  </script>

  <!-- Estilos cr√≠ticos inline -->
  <style>
    *,*::before,*::after{box-sizing:border-box;}
    html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;line-height:1.5;}
    body{margin:0;line-height:inherit;}
    .loading{opacity:0.5;pointer-events:none;}
    .fade-in{animation:fadeIn 0.3s ease-in-out;}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    
    /* Colores Martek: Gris, Rojo, Blanco */
    :root {
      --martek-red: #DC2626;
      --martek-red-hover: #B91C1C;
      --martek-gray: #6B7280;
      --martek-dark-gray: #374151;
      --martek-light-gray: #F3F4F6;
    }
  </style>
</head>

<body class="bg-white text-gray-800 antialiased">
  
  <!-- Header -->
  <Header />
  
  <!-- Main Content -->
  <main id="main-content" class="min-h-screen">
    <slot />
  </main>
  
  <!-- Footer -->
  <Footer />

  <!-- ‚úÖ CARRITO GLOBAL - MONTADO PARA ESCUCHAR EVENTOS -->
  <GlobalCart client:load />

  <!-- ‚úÖ SCRIPT DE CARRITO PRINCIPAL -->
  <script src="/js/cart.js" is:inline></script>

  <!-- ‚úÖ SCRIPT MEJORADO - AHORA ESPERA A QUE CART.JS EST√â LISTO -->
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üõèÔ∏è Martek - Bases para camas cargado');
      
      // ‚úÖ ESPERAR A QUE CARTAPI EST√â DISPONIBLE (ROBUSTO PARA NETLIFY)
      try {
        const cartReady = await window.waitForCartAPI(15000);
        
        if (cartReady) {
          console.log('‚úÖ Layout: CartAPI disponible');
          
          // ‚úÖ Aqu√≠ puedes ejecutar c√≥digo que dependa del carrito
          // Por ejemplo, actualizar contador inicial
          if (typeof window.updateCartCounter === 'function') {
            window.updateCartCounter();
          }
          
        } else {
          console.warn('‚ö†Ô∏è Layout: CartAPI no disponible despu√©s de 15 segundos');
          
          // ‚úÖ FALLBACK: Intentar cargar cart.js manualmente
          console.log('üîÑ Intentando cargar cart.js manualmente...');
          const script = document.createElement('script');
          script.src = '/js/cart.js';
          script.onload = () => {
            console.log('‚úÖ cart.js cargado manualmente');
            setTimeout(() => {
              if (typeof window.CartAPI !== 'undefined') {
                console.log('‚úÖ CartAPI ahora disponible');
              }
            }, 1000);
          };
          script.onerror = () => {
            console.error('‚ùå Error cargando cart.js manualmente');
          };
          document.head.appendChild(script);
        }
      } catch (error) {
        console.error('‚ùå Error en verificaci√≥n de CartAPI:', error);
      }
    });
  </script>
</body>
</html>